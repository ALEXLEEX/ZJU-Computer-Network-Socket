# ZJU-COMPUTER-NETWORK-LAB7

浙江大学2024-2025秋冬学期计算机网络lab7：基于Socket接口实现自定义协议通信

---

## 项目结构

```Bash
.
├── README.md
├── references
│   └── socket编程示例.pdf
└── src
    ├── client
    └── server
```

---

## 参考资源

- [geeksforgeeks.org](https://www.geeksforgeeks.org/socket-programming-in-cpp/)
- [socket编程示例](references/socket编程示例.pdf)

---

## 功能要求

根据自定义的协议规范，使用Socket编程接口编写基本的网络应用软件

- 开发一个客户端，实现人机交互界面和与服务器的通信
- 开发一个服务端，实现并发处理多个客户端的请求

1. 运输层协议采用TCP或UDP，客户端和服务端必须同时支持两种协议，在程序运行时，通过配置或命令行参数选择使用其中一种
2. 客户端采用交互菜单形式，用户可以选择以下功能：
   1. **连接**：请求连接到指定地址和端口的服务端服务端可以运行多个实例（绑定不同的地址或端口），客户端可以同时与多个服务端保持连接，一旦连接成功，给服务端分配一个ID，用于后续操作。
   2. **断开连接**：断开与指定ID的服务端的连接
   3. **获取城市名字**：向指定ID的服务端请求给出某个区号对应的中英文城市名称
   4. **获取气象信息**: 向指定ID的服务端请求给出指定日期、指定城市的气象信息，气象信息包括气温、阴/晴/雨状态、风向、风力、湿度等
   5. **活动连接列表**：向指定ID的服务端请求给出当前连接的所有客户端信息（编号、IP地址、端口等）
   6. **发消息**：请求服务端把消息转发给对应编号的客户端，该客户端收到后显示在屏幕上
   7. **退出**：断开所有服务端的连接并退出客户端程序

    同时，客户端后台接收服务端推送的消息，解码后以人类可读的形式，实时显示在屏幕上服务端推送的消息包括：
       1. 其他客户端发送的消息
       2. 其他客户端上线、下线的消息
       3. 气象预警信息，包括地震、台风等

3. 服务端接收到客户端请求后，根据客户端传过来的指令完成特定任务：
   1. 服务端可以同时接受多个客户端连接和请求，一旦客户端连接成功，给客户端分配一个ID，用于后续操作
   2. 向客户端传送所请求的区号对应的城市名称服务端从一个配置文件中读取城市和区号的对照列表，配置文件初始时至少有20个城市，后期可增加城市，不同的服务端实例可以有不同的配置数据，首次运行时加载。如果请求的区号不在配置列表中，返回相应的错误信息。
   3. 向客户端传送服务端所请求的日期、城市的气象信息服务端从一个配置文件中读取所有城市七天内的气象信息，配置文件初始时至少有20个城市的七天内气象信息，后期可增加城市，不同的服务端实例可以有不同的配置数据，首次运行时加载。如果请求的城市或者日期不在配置列表中，返回相应的错误信息。
   4. 向客户端传送当前连接的所有客户端信息（ID、IP地址、端口等）
   5. 当客户端连接成功后，向其他在线的客户端推送该客户端上线的消息当客户端断开连接后，向其他在线的客户端推送该客户端下线的消息。
   6. 将某客户端发送过来的内容转发给指定ID的其他客户端，如果ID不存在或未连接，返回相应的错误信息
   7. 采用异步多线程编程模式，正确处理多个客户端同时连接，同时发送消息的情况

同时，服务端提供人机交互界面，实现人工触发向所有在线的客户端推送气象预警消息的功能气象预警信息包括地震和台风两类。地震信息包括地震时间、震中经纬度、震级。台风信息包括台风中心经纬度、级别、预计登录地点和时间。

!!! warning 注意
    ==本实验涉及到网络数据包发送部分不能使用任何的Socket封装类，只能使用最底层的C语言形式的Socket API程序应使用标准C或C++语言==

---

## 操作方法

设计数据包的格式，至少要考虑如下问题：

1. 考虑TCP与UDP的差异，实现基于TCP和UDP的不同设计
2. 可以采用二进制或文本形式，针对TCP模式，需要考虑如何在一串连续的字节流中区分多个数据包
3. 定义数据包总体结构，考虑结束标记、各字段之间的分隔形式（固定顺序、长度控制或采用分隔符）、长度、包体、校验等数据包总体分为请求、指示（服务器主动发给客户端的）、响应三类，每一类可以有自己的格式
4. 所有数据包中都要设置一个校验字段，其值为将除校验字段以外的数据包各相关字段与开发者学号连接后通过MD5散列计算的结果，即=**MD5（数据包各相关字段+学号）**，参与校验的数据包字段可自行选择，但应包含足够多的信息且双方要一致客户端和服务端均要记录对方的学号，收到每个数据包首先要对校验字段进行验证（同样算一遍，看结果是否一致）。校验不正确的数据包要丢弃（可选择是否返回错误信息）
5. 定义每种数据包包体，应包含**控制部分和数据部分**。控制部分要包含**数据包类型、序号、数据长度**，根据请求、指示、响应的不同特点设计不同的结构。数据部分要根据不同类型设计不同的结构（特别是考虑客户端列表数据如何表达）。

### 客户端编写步骤（需要采用多线程模式）

1. 运行初始化，调用socket()，向操作系统申请socket句柄
2. 编写一个菜单功能，列出7个选项
3. 等待用户选择
4. 根据用户选择，做出相应的动作（未连接时，只能选连接功能和退出功能）
   1. 选择连接功能：请用户输入服务端IP和端口，然后调用connect()，等待返回结果并打印连接成功后设置连接状态为已连接。为该服务端分配一个ID，然后**创建一个接收数据的子线程，循环调用receive()，如果收到了一个完整的响应数据包，就通过线程间通信（如消息队列）发送给主线程，然后继续调用receive()，直至收到主线程通知退出**。
   2. 选择断开功能：调用close()，并设置连接状态为未连接通知并等待子线程关闭。将服务端ID设置为无效。
   3. 选择获取城市名称功能：请用户输入要查询的城市区号，然后组装请求数据包，类型设置为城市名称请求，数据参数设置为输入的区号，然后调用send()将请求数据包发送给服务端，接着等待接收数据的子线程返回结果，并根据响应数据包的内容，打印城市名称信息
   4. 选择获取气象信息功能：请用户输入要查询的城市区号、日期，然后组装请求数据包，类型设置为气象信息请求，数据参数设置为输入的城市区号、日期，然后调用send()将数据发送给服务端，接着**等待接收数据的子线程返回结果**，并根据响应数据包的内容，打印气象信息
   5. 选择获取客户端列表功能：组装请求数据包，类型设置为列表请求，然后调用send()将数据发送给服务器，接着等待接收数据的子线程返回结果，并根据响应数据包的内容，打印客户端列表信息（编号、IP地址、端口等）
   6. 选择发送消息功能（选择前需要先获得客户端列表）：请用户输入客户端的列表编号和要发送的内容，然后组装请求数据包，类型设置为消息请求，然后调用send()将数据发送给服务端，接着等待接收数据的子线程返回结果，并根据响应数据包的内容，打印消息发送结果（是否成功送达另一个客户端）
   7. 选择退出功能：判断是否存在已连接的服务端，是则先将所有服务端断开，然后再退出程序否则，直接退出程序。
   8. 主线程除了在等待用户的输入外，还在处理子线程的消息队列，如果有消息到达，则进行处理，如果是响应消息，则打印响应消息的数据内容（比如时间、名字、客户端列表等）；如果是指示消息，则打印指示消息的内容（比如服务器转发的别的客户端的消息内容、发送者编号、IP地址、端口等）
   9. **针对 UDP 模式，需要定义特殊类型的请求和响应，用于建立连接和释放连接客户端收到服务端连接成功的响应后记录状态。如果处于未连接状态，只能发送连接请求，不能发送其他请求。接收数据时调用recvfrom()，发送数据时调用sendto()**。

### 服务端编写步骤（需要采用多线程模式）

1. 运行初始化，解析运行配置或命令行参数，加载城市区号配置文件、气象信息配置文件
2. 调用socket()，向操作系统申请socket句柄
3. 调用bind()，绑定监听端口（**使用学号的后4位作为服务器的默认监听端口，同时可通过配置文件或者命令行参数设置为别的**），接着调用listen()，设置连接等待队列长度
4. 主线程循环调用accept()，直到返回一个有效的socket句柄，在客户端列表中增加一个新客户端的项目，分配一个新的ID，并记录下该客户端句柄和连接状态、端口然后创建一个子线程后继续调用accept()。该子线程的主要步骤是（**刚获得的句柄要传递给子线程，子线程内部要使用该句柄发送和接收数据**）：
   - 调用send()，发送一个握手（hello）消息给客户端（可选）
   - 循环调用receive()，如果收到了一个完整的请求数据包，根据请求类型做相应的动作：
       1. 请求类型为获取城市名称：从数据包中提取请求的区号参数，然后将对应的城市名称数据组装进响应数据包，调用send()发给客户端如果区号不正确，将错误代码和出错描述信息组装进响应数据包，调用send()发回源客户端。
       2. 请求类型为获取气象信息：从数据包中提取请求的区号、日期参数，将对应的气象信息（气温、阴/晴/雨状态）组装进响应数据包，调用send()发给客户端如果区号、日期不正确，将错误代码和出错描述信息组装进响应数据包，调用send()发回源客户端。
       3. 请求类型为获取客户端列表：读取客户端列表数据，将ID、IP地址、端口等数据组装进响应数据包，调用send()发给客户端
       4. 请求类型为发送消息：根据ID读取客户端列表数据，如果ID不存在，将错误代码和出错描述信息组装进响应数据包，调用send()发回源客户端；如果ID存在并且状态是已连接，则将要转发的消息组装进指示数据包调用send()发给接收客户端（使用接收客户端的socket句柄），发送成功后组装转发成功的响应数据包，调用send()发回源客户端。
5. 主线程还负责检测退出指令（如用户按退出键或者收到退出信号），检测到后即通知并等待各子线程退出最后关闭Socket，主程序退出。
6. **针对 UDP 模式，需要定义特殊类型的请求和响应，用于建立连接和释放连接服务端检测该客户端是否处于已连接状态，如果未连接时收到除了连接/释放连接请求之外的其他请求，则发回未连接的错误响应。重复收到连接/释放连接请求时，根据当前连接状态返回适合的响应。接收数据时调用recvfrom()，发送数据时调用sendto()**。

### 其它

- 在一次连接中，双方对于接收到的过期序号、重复序号的数据包应予丢弃，序号在一定范围内滚动使用重新连接后状态复位。建立连接时，默认起始序号为0，也可以进行协商。
- 编程结束后，双方程序运行，检查是否实现功能要求，如果有问题，查找原因，并修改，直至满足功能要求
- 运行多个服务端实例（IP地址、端口之一要不同），用一个客户端同时连接多个服务端，测试功能是否正确
- 使用多个客户端同时连接服务端，检查并发性
- 使用Wireshark抓取每个功能的交互数据包
